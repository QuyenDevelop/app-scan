import { shipmentApi } from "@api";
import { Header } from "@components";
import { SCREENS } from "@configs";
import { Alert } from "@helpers";
import {
  CustomerResponse,
  ExploitShipmentImage,
  ShipmentImages,
  ShipmentResponse,
  SubShipment,
  SubShipmentViewModel,
} from "@models";
import {
  FeedbackStackList,
  goToAddExploitPhotosScreen,
  goToScanShipmentCodeScreen,
} from "@navigation";
import { RouteProp, useNavigation, useRoute } from "@react-navigation/native";
import { IRootState } from "@redux";
import { Button, translate } from "@shared";
import { Themes } from "@themes";
import React, {
  FunctionComponent,
  useCallback,
  useEffect,
  useState,
} from "react";
import {
  ScrollView,
  Text,
  TextInput,
  TouchableWithoutFeedback,
  View,
} from "react-native";
import { useSelector } from "react-redux";
import { PhotoModal } from "../Scan/components/PhotoModal";
import { ShipmentInfo } from "./components/ShipmentInfo";
import { ShipmentPhotoList } from "./components/ShipmentPhotoList";
import { ShipmentHeader } from "./components/ShipmentTitle";
import styles from "./styles";

type NavigationRoute = RouteProp<FeedbackStackList, SCREENS.FEED_BACK_SCREEN>;
export interface FeedbackParams {
  item: ShipmentResponse;
}
export const FeedbackScreen: FunctionComponent = () => {
  const routeNavigation = useRoute<NavigationRoute>();
  const navigation = useNavigation();
  const { item } = routeNavigation?.params;
  const [isShowPhotoModal, setShowPhotoModal] = useState(false);
  const [images, setImages] = useState<Array<ShipmentImages>>([]);
  const [subShipments, setSubShipments] = useState<Array<SubShipment>>([
    { Length: 0, Width: 0, Height: 0, TotalGrossWeight: 0, LocationName: "" },
  ]);
  const postOffices = useSelector((state: IRootState) => state.account.profile);
  const userInfo = useSelector((state: IRootState) => state.account.profile);
  const [customerTitle, setCustomerTitles] = useState<String>(
    item.CustomerName,
  );
  const [customerID, setCustomerID] = useState<string>(item.CustomerId);
  const [isLoading, setIsLoading] = useState(false);
  const [customer, setCustomer] = useState<CustomerResponse | undefined>();
  const [description, setDescription] = useState("");

  useEffect(() => {
    getSubShipments();
    getShipmentItems();
  }, []);

  // call api Get Shipment Detail => List Image
  const getShipmentItems = () => {
    shipmentApi
      .getDetailShipment({
        shipmentId: item.ShipmentId,
        option: 3,
      })
      ?.then(response => {
        // console.log(JSON.stringify(response));
        if (response && response.success) {
          response.data.ShipmentItems[0].Images.length
            ? response.data.ShipmentItems[0].Images.slice(-5).map(img => {
                setImages(i => [
                  ...i,
                  {
                    Id: img.Id,
                    Name: img.Name,
                    Url: img.Url,
                  },
                ]);
              })
            : setImages([]);
        }
      });
  };

  const updateInfoSubShipment = useCallback(
    (subShipment: SubShipment, index: 0) => {
      const newSub = [...subShipments];
      newSub[index] = subShipment;
      setSubShipments(newSub);
    },
    [subShipments],
  );
  const updatePhotoList = useCallback(
    (photos: Array<ShipmentImages>, imgList?: Array<ShipmentImages>) => {
      // ---- trường hợp nếu initialState k được truyền == Delete item
      // ---- trường hợp nếu initialState được truyền == Add item
      const newSub = imgList ? imgList.concat(photos) : photos;
      setImages(newSub.slice(-5));
    },
    [images],
  );

  const updateCustomer = useCallback((custom: CustomerResponse) => {
    setCustomer(custom);
    setCustomerTitles(custom.Name);
    setCustomerID(custom.Id);
  }, []);

  const getSubShipments = () => {
    shipmentApi
      .getDetailShipment({
        shipmentId: item.ShipmentId,
        option: 2,
      })
      ?.then(response => {
        if (
          response &&
          response.success &&
          response.data.SubShipments.length > 0
        ) {
          setSubShipments(response.data.SubShipments);
        }
      });
  };

  const onViewImage = () => {
    goToAddExploitPhotosScreen({
      shipmentId: item.ShipmentId,
      images: images,
      updateImagesList: updatePhotoList,
    });
  };

  const RenderButton = () => {
    return (
      <View>
        <Button
          isLoading={isLoading}
          title={translate("button.send")}
          onPress={() => toggleSend()}
          buttonChildStyle={styles.updateButton}
        />
      </View>
    );
  };

  // ---- toggle send - chờ có API
  const toggleSend = () => {
    setIsLoading(true);
    if (!customerID) {
      Alert.error("error.validation.customer");
      return;
    }
    const subShipmentRequest = subShipments.map(
      (subShipment: SubShipment): SubShipmentViewModel => {
        return {
          id: subShipment.Id,
          shipmentId: subShipment.ShipmentId,
          length: subShipment.Length,
          width: subShipment.Width,
          height: subShipment.Height,
          totalGrossWeight: subShipment.TotalGrossWeight * 1000,
          status: 0,
          subShipmentNumber: subShipment.SubShipmentNumber,
          referenceNumber: subShipment.ReferenceNumber,
          locationName: subShipment.LocationName,
          totalChargeableWeight: subShipment.TotalChargeableWeight,
          orderNumber: subShipment.OrderNumber,
        };
      },
    );
    const imagesExploit = images.map(
      (image: ShipmentImages): ExploitShipmentImage => {
        return {
          name: image.Name,
          url: image.Url,
        };
      },
    );
    shipmentApi
      .exploitShipment({
        id: item.ShipmentId,
        customerId: customerID || "",
        postOfficeToSendId: postOffices?.postOfficeId || "",
        images: imagesExploit,
        expectedPieces: 1,
        pieces: 1,
        subShipmentViewModels: subShipmentRequest,
        note: description,
        createdBy: userInfo?.sub || "",
        createdByUserName: userInfo?.preferred_username || "",
      })
      ?.then(response => {
        if (response.Status) {
          // console.log("Response: " + JSON.stringify(response));
          Alert.success("success.success");
          goToScanShipmentCodeScreen();
        }
      })
      .catch(() => Alert.error("error.errorSever"))
      .finally(() => {
        setIsLoading(false);
      });
  };

  return (
    <>
      <Header
        title={translate("screens.shipmentDetail")}
        iconLeftName={["ic_arrow_left"]}
        iconLeftOnPress={[() => navigation.goBack()]}
        isCenterTitle
        titleColor={Themes.colors.white}
      />
      <ScrollView style={styles.container} showsVerticalScrollIndicator={false}>
        <TouchableWithoutFeedback>
          <>
            <ShipmentHeader
              shipmentTitle={item.ShipmentNumber}
              customerTitle={customerTitle}
              customer={customer}
              selectCustomer={updateCustomer}
            />
            <ShipmentPhotoList
              // shipment={shipmentDetail}
              images={images}
              showPhotoModal={() => setShowPhotoModal(true)}
              onViewImage={onViewImage}
            />
            <ShipmentInfo
              subShipment={subShipments[0]}
              updateSubShipment={updateInfoSubShipment}
            />
            <View style={[styles.subShipmentContainer, styles.boxShipmentIfo]}>
              <Text style={styles.labelInfo}>
                {translate("placeholder.enterContent")}
              </Text>
              <TextInput
                style={styles.NoteInput}
                contextMenuHidden={true}
                placeholder={translate("placeholder.enterContent")}
                onChangeText={(text: string) => {
                  setDescription(text);
                }}
                value={description || ""}
                multiline={true}
              />
            </View>
            <RenderButton />
          </>
        </TouchableWithoutFeedback>
        <PhotoModal
          isShowModal={isShowPhotoModal}
          closeModal={() => setShowPhotoModal(false)}
          shipment={item.ShipmentId}
          reUpdateImagesList={updatePhotoList}
          images={images}
        />
      </ScrollView>
    </>
  );
};
