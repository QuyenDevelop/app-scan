/* eslint-disable react-native/no-inline-styles */
import { shipmentApi } from "@api";
import { Header } from "@components";
import { CONSTANT } from "@configs";
import { Alert, ScreenUtils } from "@helpers";
import { useShow } from "@hooks";
import { PlatformAndroidStatic } from "@models";
import { BarcodeMask, useBarcodeRead } from "@nartc/react-native-barcode-mask";
import { goToFeedbackScreen } from "@navigation";
import { useIsFocused, useNavigation } from "@react-navigation/native";
import { Icon, Text, translate } from "@shared";
import { Metrics, Themes } from "@themes";
import React, { FunctionComponent, useEffect, useRef, useState } from "react";
import {
  ActivityIndicator,
  Dimensions,
  Keyboard,
  Platform,
  TextInput,
  TouchableOpacity,
  Vibration,
  View,
} from "react-native";
import { RNCamera } from "react-native-camera";
import { useSafeAreaInsets } from "react-native-safe-area-context";
import { EnterCodeModal } from "../Scan/components/EnterCodeModal";
import styles from "./styles";

export const ScanShipmentCodeScreen: FunctionComponent = () => {
  const insets = useSafeAreaInsets();
  const isFocused = useIsFocused();
  const navigation = useNavigation();
  const { barcodeRead, onBarcodeRead, onBarcodeFinderLayoutChange } =
    useBarcodeRead(
      isFocused,
      barcodeData => {
        return barcodeData;
      },
      async processedBarcodeData => {
        await getShipment(processedBarcodeData.trim());
      },
      3000,
    );
  const [isLoadingFetchData, showIsLoadingFetchData, hideIsLoadingFetchData] =
    useShow();
  const inputRef = useRef<TextInput>(null);
  const [content, setContent] = useState<string>("");
  const [isShowEnterCode, showEnterCode, hideEnterCode] = useShow();
  const [errorContent, setErrorContent] = useState<string>("");
  const [shipmentCode, setShipmentCode] = useState<string>("");
  const PlatformBrandConstraint = Platform.constants as PlatformAndroidStatic;

  useEffect(() => {
    PlatformBrandConstraint.Brand === CONSTANT.PLATFORM_BRAND.HONEYWELL &&
      inputRef.current &&
      inputRef.current.focus();
  }, [PlatformBrandConstraint.Brand]);

  const onRead = ({ barcodes }: { barcodes: any }) => {
    if (isLoadingFetchData || barcodeRead) {
      return;
    }

    if (barcodes.length > 0) {
      Vibration.vibrate();
      setContent(barcodes[0]?.data);
      onBarcodeRead(barcodes[0]?.data);
      // getShipment(barcodes[0]?.data);
    }
  };

  const getShipment = (value: string | null) => {
    setErrorContent("");
    if (!value || value === "") {
      Alert.error("error.errBarCode");
      return;
    }
    showIsLoadingFetchData();
    shipmentApi
      .scanShipment(value)
      ?.then(shipment => {
        if (shipment?.success && shipment?.data) {
          if (shipment.data.length === 0) {
            setErrorContent(translate("error.noShipment"));
            setShipmentCode("");
            return;
          }

          if (shipment.data.length === 1) {
            goToFeedbackScreen({ items: shipment.data[0] });
            return;
          }
        } else {
          setErrorContent(shipment?.message || "");
          setShipmentCode("");
        }
      })
      .catch(() => {
        Alert.error("error.errorServer");
      })
      .finally(() => {
        Keyboard.dismiss();
        setContent("");
        setShipmentCode("");
        setTimeout(() => {
          hideIsLoadingFetchData();
        }, 500);
      });
  };

  return (
    <View style={styles.container}>
      {isFocused &&
      PlatformBrandConstraint.Brand !== CONSTANT.PLATFORM_BRAND.HONEYWELL ? (
        <RNCamera
          style={styles.camera}
          type={RNCamera.Constants.Type.back}
          flashMode={RNCamera.Constants.FlashMode.on}
          captureAudio={false}
          onGoogleVisionBarcodesDetected={onRead}
        >
          <BarcodeMask
            width={300}
            height={Dimensions.get("screen").height * 0.25}
            showAnimatedLine={false}
            maskOpacity={0.1}
            onLayoutChange={onBarcodeFinderLayoutChange}
          />
          <View style={styles.markerView}>
            <View style={styles.topView}>
              {!!errorContent && (
                <>
                  <Icon
                    name="ic_shipment"
                    size={Metrics.icons.tiny}
                    color={Themes.colors.warningMain}
                  />
                  <Text style={styles.errorContent}>{errorContent}</Text>
                </>
              )}
            </View>
            <View style={styles.centerView}>
              {isLoadingFetchData && Platform.OS === "ios" && (
                <View style={styles.loadingView}>
                  <ActivityIndicator color={Themes.colors.collGray40} />
                </View>
              )}
            </View>
            <View
              style={[styles.bottomView, { paddingBottom: insets.bottom + 15 }]}
            >
              <View>
                <Text style={styles.qrUserManual}>
                  {translate("label.qrUserManual")}
                </Text>
                <TouchableOpacity
                  style={styles.enterKeyboardButton}
                  onPress={showEnterCode}
                >
                  <Icon
                    name="ic_keyboad"
                    size={Metrics.icons.tiny}
                    color={Themes.colors.white}
                  />
                  <Text style={styles.qrUserManual}>
                    {translate("button.enterCode")}
                  </Text>
                </TouchableOpacity>
              </View>
              <TouchableOpacity onPress={() => navigation.goBack()}>
                <Icon
                  name="ic_close_circle"
                  size={Metrics.icons.large}
                  color={Themes.colors.white}
                />
              </TouchableOpacity>
            </View>
          </View>
        </RNCamera>
      ) : (
        <View style={{ flex: 1 }}>
          <Header
            title={translate("screens.checkAndScan")}
            iconLeftName={["ic_arrow_left"]}
            iconLeftOnPress={[() => navigation.goBack()]}
            isCenterTitle
            titleColor={Themes.colors.white}
          />
          <View style={styles.inputView}>
            <TextInput
              ref={inputRef}
              placeholder={translate("placeholder.scanOrType")}
              style={styles.inputCode}
              value={shipmentCode}
              contextMenuHidden={true}
              onChangeText={text => setShipmentCode(text)}
              onSubmitEditing={_e => {
                getShipment(shipmentCode);
              }}
              returnKeyType="done"
              returnKeyLabel="Add"
              blurOnSubmit={false}
            />
            <TouchableOpacity
              style={{ padding: ScreenUtils.scale(8) }}
              onPress={() => getShipment(shipmentCode)}
            >
              <Icon
                name="ic_plus"
                color={Themes.colors.bg}
                size={Metrics.icons.small}
              />
            </TouchableOpacity>
          </View>
        </View>
      )}
      <EnterCodeModal
        isShowModal={isShowEnterCode}
        closeModal={hideEnterCode}
        code={content}
        onChangeCode={setContent}
        onCheckCode={getShipment}
      />
    </View>
  );
};
