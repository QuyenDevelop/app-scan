import { Header } from "@components";
import { DATA_CONSTANT, SCREENS } from "@configs";
import { useShow, useToggle } from "@hooks";
import { ShipmentImages } from "@models";
import { goToPhotoLibrary, ShipmentStackParamsList } from "@navigation";
import { RouteProp, useNavigation, useRoute } from "@react-navigation/native";
import { DeleteModal, Icon, ImagesModal, Text, translate } from "@shared";
import { Metrics, Themes } from "@themes";
import React, { FunctionComponent, useEffect, useState } from "react";
import {
  ActivityIndicator,
  FlatList,
  TouchableOpacity,
  View,
} from "react-native";
import { ImageItem } from "./component/ImageItem";
import styles from "./styles";

type NavigationRoute = RouteProp<
  ShipmentStackParamsList,
  SCREENS.EXPLOIT_UPLOAD_SCREEN
>;
export interface AddExploitPhotosScreenParams {
  shipmentId?: string;
  images: Array<ShipmentImages>;
  updateImagesList: (
    photos: Array<ShipmentImages>,
    imgList?: Array<ShipmentImages>,
  ) => void;
}

export const ExploitShipmentUploadScreen: FunctionComponent = () => {
  const navigation = useNavigation();
  const route = useRoute<NavigationRoute>();
  const { images, updateImagesList, shipmentId } = route?.params;
  const [isShowDelete, showDelete, hideDelete] = useShow();
  const [isLoading, showLoading, hideLoading] = useShow();
  const [photosShow, setPhotosShow] = useState<Array<string>>([]);
  const [photosSelected, setPhotosSelected] = useState<Array<string>>([]);
  const [isSelectMode, toggleMode] = useToggle();
  const [isShowImage, showImage, hideImage] = useShow();
  const [indexShowImage, setIndexShowImage] = useState<number>(0);

  useEffect(() => {
    setPhotosShow(images ? images.map(photo => photo.Url) : []);
  }, [images]);

  const isSelected = (id: string) => {
    return photosSelected.includes(id);
  };

  const onSelect = (id: string, index: number) => {
    if (!isSelectMode) {
      setIndexShowImage(index);
      showImage();
      return;
    }

    if (isSelected(id)) {
      setPhotosSelected(image => image.filter(index => index !== id));
    } else {
      setPhotosSelected(image => [...image, id]);
    }
  };

  const renderItem = ({
    item,
    index,
  }: {
    item: ShipmentImages;
    index: number;
  }) => {
    const isCheck = isSelected(item.Url);
    return (
      <ImageItem
        id={item.Url}
        uri={item.Url}
        isChecked={isCheck}
        onSelect={onSelect}
        index={index}
      />
    );
  };

  const goToLibrary = () => {
    goToPhotoLibrary({
      // reUpdateImagesList: updateImagesList,
      prefix: `${shipmentId}`,
      suffix: DATA_CONSTANT.SUFFIX_IMAGE.shipmentImages,
    });
  };

  const removeImage = () => {
    showLoading();
    const term = images.filter(image => !photosSelected.includes(image.Url));
    updateImagesList(term);
    navigation.goBack();
    hideLoading();
  };

  const changeMode = () => {
    setPhotosSelected([]);
    toggleMode();
  };

  return (
    <View style={styles.container}>
      <Header
        title={translate("button.shipmentImages")}
        iconLeftName={["ic_arrow_left"]}
        iconLeftOnPress={[() => navigation.goBack()]}
        isCenterTitle
        titleColor={Themes.colors.white}
        titleRight={
          isSelectMode ? translate("button.cancel") : translate("button.choose")
        }
        titleRightStyle={styles.titleRight}
        titleRightOnPress={changeMode}
      />
      <View style={styles.content}>
        <FlatList
          data={images}
          keyExtractor={(item, index) => `${item}_${index}`}
          renderItem={renderItem}
          numColumns={3}
        />
        {isSelectMode && (
          <View style={styles.bottomView}>
            <TouchableOpacity onPress={goToLibrary}>
              <Icon
                name="ic_library"
                size={Metrics.icons.medium}
                color={Themes.colors.coolGray100}
              />
            </TouchableOpacity>
            <Text>
              {translate("label.selectedNumber", {
                number: photosSelected.length,
              })}
            </Text>
            <TouchableOpacity
              disabled={photosSelected.length === 0}
              onPress={showDelete}
            >
              <Icon
                name="ic_delete"
                size={Metrics.icons.medium}
                color={
                  photosSelected.length > 0
                    ? Themes.colors.coolGray100
                    : Themes.colors.collGray40
                }
              />
            </TouchableOpacity>
          </View>
        )}

        {isLoading && (
          <View style={styles.loadingView}>
            <ActivityIndicator color={Themes.colors.white} />
          </View>
        )}
      </View>
      <DeleteModal
        isVisible={isShowDelete}
        closeModal={hideDelete}
        message={translate("alert.deleteImages", {
          number: photosSelected.length,
        })}
        confirmDelete={removeImage}
      />
      <ImagesModal
        images={photosShow}
        isVisible={isShowImage}
        closeModal={hideImage}
        index={indexShowImage}
        // isLocalImage={true}
      />
    </View>
  );
};
